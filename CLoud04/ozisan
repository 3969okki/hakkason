#https://discord.com/oauth2/authorize?client_id=1215490842832412793&permissions=8&scope=bot+applications.commands
import discord
import jaconv
import MeCab
import random
import json 
from discord import app_commands

m = MeCab.Tagger('')


intents = discord.Intents.all()
client = discord.Client(intents=intents)
tree = app_commands.CommandTree(client)


def emojiSet():
    emoji = ''
    if (random.randrange(2) % 2) == 0:
        emoji = random.choice('ğŸ˜ğŸ˜ŠğŸ˜ƒğŸ˜‚ğŸ˜ğŸ˜¢ğŸ˜ğŸ¤—')
    if (random.randrange(2) % 2) == 0:
        emoji = emoji + random.choice('â¤ï¸ğŸ‘âœ‹ğŸ’¦â€¼')
    return emoji


def bunsetsuWakachi(text):
    m_result = m.parse(text).splitlines()
    m_result = m_result[:-1] #æœ€å¾Œã®1è¡Œã¯ä¸è¦ãªè¡Œãªã®ã§é™¤ã
    #break_pos = ['åè©','å‹•è©','æ¥é ­è©','å‰¯è©','æ„Ÿå‹•è©','å½¢å®¹è©','å½¢å®¹å‹•è©','é€£ä½“è©'] #æ–‡ç¯€ã®åˆ‡ã‚Œç›®ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã®å“è©ãƒªã‚¹ãƒˆ
    break_pos = ['åè©','å‹•è©','æ¥é ­è©','å‰¯è©','æ„Ÿå‹•è©','å½¢å®¹å‹•è©','é€£ä½“è©'] #æ–‡ç¯€ã®åˆ‡ã‚Œç›®ã‚’æ¤œå‡ºã™ã‚‹ãŸã‚ã®å“è©ãƒªã‚¹ãƒˆ
    wakachi = [''] #åˆ†ã‹ã¡æ›¸ãã®ãƒªã‚¹ãƒˆ
    afterPrepos = False #æ¥é ­è©ã®ç›´å¾Œã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    afterSahenNoun = False #ã‚µå¤‰æ¥ç¶šåè©ã®ç›´å¾Œã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
    for v in m_result:
        if '\t' not in v: continue
        surface = v.split('\t')[0] #è¡¨å±¤ç³»
        pos = v.split('\t')[1].split(',') #å“è©ãªã©
        pos_detail = ','.join(pos[1:4]) #å“è©ç´°åˆ†é¡ï¼ˆå„è¦ç´ ã®å†…éƒ¨ãŒã•ã‚‰ã«'/'ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‚‹ã®ã§ã€','ã§joinã—ã¦ã€inã§åˆ¤å®šã™ã‚‹)
        #ã“ã®å˜èªãŒæ–‡ç¯€ã®åˆ‡ã‚Œç›®ã¨ãªã‚‰ãªã„ã‹ã©ã†ã‹ã®åˆ¤å®š
        noBreak = pos[0] not in break_pos
        noBreak = noBreak or 'æ¥å°¾' in pos_detail
        noBreak = noBreak or (pos[0]=='å‹•è©' and 'ã‚µå¤‰æ¥ç¶š' in pos_detail)
        noBreak = noBreak or 'éè‡ªç«‹' in pos_detail #éè‡ªç«‹ãªåè©ã€å‹•è©ã‚’æ–‡ç¯€ã®åˆ‡ã‚Œç›®ã¨ã—ãŸã„å ´åˆã¯ã“ã®è¡Œã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã™ã‚‹
        noBreak = noBreak or afterPrepos
        noBreak = noBreak or (afterSahenNoun and pos[0]=='å‹•è©' and pos[4]=='ã‚µå¤‰ãƒ»ã‚¹ãƒ«')
        if noBreak == False:
            wakachi.append("")
        wakachi[-1] += surface
        # afterPrepos = pos[0]=='æ¥é ­è©'
        afterSahenNoun = 'ã‚µå¤‰æ¥ç¶š' in pos_detail
    if wakachi[0] == '': wakachi = wakachi[1:] #æœ€åˆãŒç©ºæ–‡å­—ã®ã¨ãå‰Šé™¤ã™ã‚‹
    return wakachi

#ã“ã“ã«ãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ ã™ã‚‹
#
# ã™ã‚‰ã—ã‚…ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè£…
#with open("idMemory.json", "r", encoding="utf-8") as json_file:
json_file = open("idMemory.json", "r", encoding="utf-8")
data = json.load(json_file)


@client.event
async def on_ready():
    print("èµ·å‹•å®Œäº†")
    await tree.sync()


@tree.command(name='ohayou', description='Make the bot usable. Please set channelID')
async def id_set(interaction: discord.Interaction, x: str):
    global data
    new_data = {
        "channelId": x,
    }
    data[x] = new_data
    with open("idMemory.json", "w", encoding="utf-8") as json_file:
        json.dump(data, json_file, ensure_ascii=False, indent=4)
        await interaction.response.send_message('ä»Šæ—¥ã‚‚é ‘å¼µã£ã¡ã‚ƒã†ãƒ§ï½ğŸ˜ğŸ‘')


@tree.command(name='oyasumi', description='Make the bot do not usable. Please set channelID')
async def id_reset(interaction: discord.Interaction, j: str):
    if (random.randrange(3) % 3) == 0:
        f = open('idMemory.json', 'r', encoding="utf-8")
        jsonData = json.load(f)

        del jsonData[j]
        f.close()
        f = open('idMemory.json', 'w', encoding="utf-8")
        json.dump(jsonData, f, indent='\t', ensure_ascii=False)
        f.close()
        await interaction.response.send_message('ã‚¹ãƒ¤ã‚¡ğŸ˜')
    else:
        await interaction.response.send_message('ãŠã˜ã•ã‚“ğŸ˜ã¨ä¸€ç·’ã«å¯ãŸã„ã®ã‚«ãƒŠï¼ŸãƒŠãƒ³ãƒãƒ£ãƒƒãƒ†ğŸ¤—')
        


@client.event
async def on_message(message):

    check = str(message.channel.id)
    json_file = open("idMemory.json", "r", encoding="utf-8")
    data = json.load(json_file)
    json_file.close()

    if check not in data:  # IDãŒjsonfileã®ä¸­ã«ãªã„å ´åˆ

        print('hello')
        return
    
    if not message.author.bot:  #ç™ºè¨€è€…ãŒBotã§ãªã„å ´åˆ

        channel = client.get_channel(message.channel.id)
        
        tmp = message.content
        tmp2 = bunsetsuWakachi(tmp)
        ret = ",".join(tmp2)
        ret = ret.replace(ret[-1:], jaconv.hira2kata(ret[-1:]))
        
        emoji = '~' + emojiSet()
        ret = ret + emoji
        for i in range(len(ret)):
            ret = ret.replace(',', random.choice(',ã€'), 1)
            emoji = emojiSet()
            ret = ret.replace(',', emoji, 1)

        pic1 = '> ' + str(message.author) + '\r\n'
        ret = pic1 + ret
        if (random.randrange(3) % 3) == 0:
            ret += 'ãƒŠãƒ³ãƒãƒ£ãƒƒãƒ†ğŸ˜'
        await message.channel.purge(limit = 1)
        await channel.send(ret)
        
        print(ret)

client.run(TOKEN)
